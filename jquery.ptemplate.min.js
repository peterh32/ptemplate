$.fn.fillInWith=function(data,options){var options=options||{};var debug=function(){};if(options.debug&&typeof console=='object'){debug=function(msg){console.log('pTemplate error: '+msg)}}if(typeof data!='object'||$.isArray(data)){debug('Data passed to fillInWith() must be an object and not an array');return $(this)}var ldelim=options.ldelim||'[[';var rdelim=options.rdelim||']]';var badField=function(fieldName){debug('Cannot find '+fieldName+' in data');return''};if(options.inPlace){var $template=$(this)}else{var $template=$(this).clone()}var filters={sIfPlural:function(value){var test=parseFloat(value);return(test==-1||test==1)?'':'s'},count:function(value){return value&&(value.length||0)}};$.extend(filters,options.extraFilters||{});var main=function($elem,data){if(typeof data!='object'||$.isArray(data)){debug('Data structure problem: '+typeof data+' passed to main');return $elem}for(var item in data){if(data.hasOwnProperty(item)&&$.isArray(data[item])){var theArray=data[item];var $replace=$elem.find('[data-repeat-on="'+item+'"]');if($replace.length==1){var $target=$replace.parent();for(var i=0;i<theArray.length;i++){if(typeof theArray[i]=='object'){var $template=$replace.clone().removeAttr('data-repeat-on');var $result=main($template,theArray[i]);$target.append($result)}else{debug('Data structure problem. '+item+'['+i+'] is a '+typeof theArray[i]+' not an object')}}$replace.remove()}else{debug("There is no repeat-on element for array: "+item)}}}$elem.find('[data-if]').each(function(){if(options.untrusted){debug('Untrusted option set; "data-if" conditional will not be evaluated')}else{var $else=$(this).find('[data-else]');var keep;with(data){keep=eval($(this).attr('data-if'))}if(keep){$else.remove()}else{$(this).replaceWith($else)}}});var elemHtml=$elem.html();var segments=elemHtml.split(ldelim);var segmentZero='';if(segments[0].indexOf(rdelim)==-1){segmentZero=segments.shift()}for(var i=0;i<segments.length;i++){var tag_and_text=segments[i].split(rdelim);var replacement;var field_and_filters=tag_and_text[0].split('|');if(field_and_filters.length>1){var theField=field_and_filters.shift();replacement=data[theField]||badField(theField);for(var j=0;j<field_and_filters.length;j++){if(typeof filters[field_and_filters[j]]=='function'){var filter=filters[field_and_filters[j]];replacement=filter(replacement)}else{debug(field_and_filters[j]+' is not a valid filter')}}}else{var theField=field_and_filters[0];replacement=data[theField]||badField(theField)}segments[i]=[replacement,tag_and_text[1]||''].join('')}segments.unshift(segmentZero);elemHtml=segments.join('');return $elem.html(elemHtml)};return main($template,data)};
